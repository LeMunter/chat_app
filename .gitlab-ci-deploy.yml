deploy:
  variables:
    test: $IMG_REGISTRY:$CI_COMMIT_BRANCH
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""] # default entry point is kubectl but we want to create the kubeconf first.
  stage: deploy
  before_script:
    - touch /.kube/config
    - echo "$K8_CONFIG" > /.kube/config
    - cat /.kube/config
  script:
    - sed -i 's/testis/$test/g' k8_test/postgres.yaml
    - cat k8_test/postgres.yaml
    - kubectl delete statefulset --all
    - kubectl delete secret regcred  --ignore-not-found
    - kubectl create secret docker-registry regcred --docker-server=$CI_REGISTRY --docker-username="$GIT_USERNAME" --docker-password="$GIT_TOKEN"
    - kubectl apply -f k8_test/
  tags:
    - k8-runner
